<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:dtos="clr-namespace:MauiApp1.AppLogic.DTOs"
             xmlns:viewmodels="clr-namespace:MauiApp1.ViewModels"
             x:Class="MauiApp1.UserManagePage"
             x:DataType="viewmodels:UserManagePageViewModel"
             Title="User Manage Page">
    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Add User" Command="{Binding GoToAddUserPageCommand}" />
    </ContentPage.ToolbarItems>

    <!-- ROOT GRID -->
    <Grid>
        
        <!-- MAIN CONTENT GRID -->
        <Grid RowDefinitions="Auto, Auto, *, Auto, Auto">
            
            <!-- Title -->
            <Label Grid.Row="0" 
                   Text="User Management" 
                   FontSize="24" 
                   FontAttributes="Bold" 
                   Padding="20,10" 
                   TextColor="{StaticResource Primary}"/>

            <!-- SEARCH BAR -->
            <SearchBar Grid.Row="1"
                       Placeholder="Search users..."
                       PlaceholderColor="{StaticResource Gray400}"
                       TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                       BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                       SearchCommand="{Binding SearchUserCommand}"
                       SearchCommandParameter="{Binding Source={RelativeSource Self}, Path=Text}"
                       Margin="20,0,20,10"
                       HeightRequest="45">
                <SearchBar.Shadow>
                    <Shadow Brush="Gray" Offset="0,2" Radius="4" Opacity="0.2" />
                </SearchBar.Shadow>
            </SearchBar>

            <RefreshView Grid.Row="2" 
                         IsRefreshing="{Binding IsRefreshing}"
                         Command="{Binding LoadUserCommand}">

                <!-- USERS LIST -->
                <CollectionView ItemsSource="{Binding Users}" 
                                SelectionMode="Single"
                                SelectionChangedCommand="{Binding SelectUserCommand}"
                                SelectionChangedCommandParameter="{Binding Source={RelativeSource Self}, Path=SelectedItem}">

                    <CollectionView.EmptyView>
                        <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center">
                            <Image Source="dotnet_bot.png" HeightRequest="100" />
                            <Label Text="No data yet please insert!" TextColor="Gray"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>

                    <!-- USER ITEM -->
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="dtos:UserDto">
                            
                            <!-- SWIPEVIEW -->
                            <SwipeView>
                                <!-- RIGHTITEMS - SWIPE TO LEFT -->
                                <SwipeView.RightItems>
                                    <SwipeItems Mode="Reveal">
                                        <SwipeItemView>
                                            <Grid 
                                                  WidthRequest="100"
                                                  Padding="10">
                                                
                                                <!-- DELETE BUTTON -->
                                                <Button Text="Delete" 
                                                        BackgroundColor="{StaticResource Error}" 
                                                        TextColor="{StaticResource White}"
                                                        FontSize="14"
                                                        FontAttributes="Bold"
                                                        WidthRequest="80"
                                                        HeightRequest="40"
                                                        CornerRadius="8"
                                                        HorizontalOptions="Center"
                                                        VerticalOptions="Center"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:UserManagePageViewModel}}, Path=DeleteUserCommand}"
                                                        CommandParameter="{Binding .}"/>
                                            </Grid>
                                        </SwipeItemView>
                                    </SwipeItems>
                                </SwipeView.RightItems>

                                <!-- ITEM MAIN CONTENT -->
                                <Border Margin="10,5" Padding="10" StrokeShape="RoundRectangle 8" Stroke="LightGray" StrokeThickness="1">
                                    <Border.Shadow>
                                        <Shadow Brush="Gray" Offset="2,2" Radius="4" Opacity="0.3" />
                                    </Border.Shadow>
                                    <Grid ColumnDefinitions="Auto, *, Auto">
                                        
                                        <Image Grid.Column="0" 
                                               Source="dotnet_bot.png" 
                                               HeightRequest="50" 
                                               WidthRequest="50" 
                                               Margin="0,0,10,0"/>

                                        <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                                            <Label Text="{Binding FullName}" FontSize="16" FontAttributes="Bold"/>
                                            <Label Text="{Binding Email}" FontSize="12" TextColor="Gray"/>
                                        </VerticalStackLayout>


                                        <Button Grid.Column="2" 
                                                Text="View Detail" 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:UserManagePageViewModel}}, Path=ShowUserDetailsCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="{StaticResource Primary}" 
                                                TextColor="{StaticResource White}" 
                                                FontSize="14" 
                                                HeightRequest="30" 
                                                WidthRequest="85"
                                                Padding="0"
                                                Margin="10,0,0,0"
                                                VerticalOptions="Center"/>
                                            
                                    </Grid>
                                </Border>
                            </SwipeView>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </RefreshView>
        </Grid>

        <!-- POPUP OVERLAY -->
        <!-- IsVisible binding with IsPopupOpen from ViewModel -->
        <Grid IsVisible="{Binding IsPopupOpen}" 
              BackgroundColor="{StaticResource PopupOverlayColor}">
            
            <!-- POPUP CARD -->
            <Border WidthRequest="350" 
                    HeightRequest="500"
                    StrokeShape="RoundRectangle 15" 
                    BackgroundColor="White"
                    Stroke="{StaticResource Primary}"
                    StrokeThickness="2"
                    Padding="20"
                    VerticalOptions="Center"
                    HorizontalOptions="Center">
                <Border.Shadow>
                    <Shadow Brush="Black" Offset="0,4" Radius="10" Opacity="0.5" />
                </Border.Shadow>
                
                <VerticalStackLayout Spacing="15">
                    
                    <Label Text="User Details" 
                           FontSize="22" 
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           TextColor="{StaticResource Primary}"
                           Margin="0,0,0,10"/>
                    
                    <Image Source="dotnet_bot.png" 
                           HeightRequest="100" 
                           WidthRequest="100"
                           HorizontalOptions="Center"
                           Margin="0,0,0,10"/>
                    
                    <!-- USER INFORMATION -->
                    <VerticalStackLayout Spacing="12">
                        
                        <!-- Full Name -->
                        <Label>
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="Full Name: " FontAttributes="Bold" TextColor="{StaticResource Gray500}"/>
                                    <Span Text="{Binding SelectedUser.FullName}" TextColor="{StaticResource Black}"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                        
                        <!-- Email -->
                        <Label>
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="Email: " FontAttributes="Bold" TextColor="{StaticResource Gray500}"/>
                                    <Span Text="{Binding SelectedUser.Email}" TextColor="{StaticResource Black}"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                        
                        <!-- Username -->
                        <Label>
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="Username: " FontAttributes="Bold" TextColor="{StaticResource Gray500}"/>
                                    <Span Text="{Binding SelectedUser.Username}" TextColor="{StaticResource Black}"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                        
                        <!-- Date of Birth -->
                        <Label>
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="Date of Birth: " FontAttributes="Bold" TextColor="{StaticResource Gray500}"/>
                                    <Span Text="{Binding SelectedUser.DateOfBirth, StringFormat='{0:dd/MM/yyyy}'}" TextColor="{StaticResource Black}"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                        
                        <!-- Age -->
                        <Label>
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="Age: " FontAttributes="Bold" TextColor="{StaticResource Gray500}"/>
                                    <Span Text="{Binding SelectedUser.Age}" TextColor="{StaticResource Black}"/>
                                    <Span Text=" years old" TextColor="{StaticResource Black}"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>

                        <!-- User ID -->
                        <Label>
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="User ID: " FontAttributes="Bold" TextColor="{StaticResource Gray500}"/>
                                    <Span Text="{Binding SelectedUser.Id}" TextColor="{StaticResource Gray400}" FontSize="12"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                        
                    </VerticalStackLayout>
                    
                    <!-- CLOSE BUTTON -->
                    <Button Text="Close" 
                            Command="{Binding ClosePopupCommand}"
                            BackgroundColor="{StaticResource Primary}"
                            TextColor="{StaticResource White}"
                            CornerRadius="10"
                            HeightRequest="45"
                            Margin="0,15,0,0"/>
                </VerticalStackLayout>
            </Border>
        </Grid>
        
    </Grid>
    <!-- END ROOT GRID -->
</ContentPage>